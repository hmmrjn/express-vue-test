'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Models = require('./models');
var LRU = require('lru-cache');
var path = require('path');
var Utils = require('./utils');
var Renderer = require('./renderer');
var vueServerRenderer = require('vue-server-renderer').createRenderer();

var cacheOptions = {
    max: 500,
    maxAge: 1000 * 60 * 60
};
var lruCache = LRU(cacheOptions);

/**
 * ExpressVueRenderer Class is the main init Class
 * init with `new ExpressVueRenderer(options)`
 * returns the ExpressVueRenderer class
 * @class
 */

var ExpressVueRenderer = function () {
    /**
     * ExpressVueRenderer constructor
     * @constructor
     * @param {Object} options - The options passed to init the class
     */
    function ExpressVueRenderer(options) {
        _classCallCheck(this, ExpressVueRenderer);

        this.GlobalOptions = new Models.Defaults(options);
        this.Cache = lruCache;
    }
    /**
     * createAppObject is an internal function used by renderToStream
     * @param  {string} componentPath - full path to .vue file
     * @param  {Object} data          - data to be inserted when generating vue class
     * @param  {Object} vueOptions    - vue options to be used when generating head
     * @return {Promise}              - Promise consists of an AppClass Object
     */


    _createClass(ExpressVueRenderer, [{
        key: 'createAppObject',
        value: function createAppObject(componentPath, data, vueOptions) {
            var _this = this;

            return new Promise(function (resolve, reject) {
                var Options = Object.create(_this.GlobalOptions);
                Options.data = Models.Defaults.mergeObjects(Options.data, data);
                // Options.mergeDataObject(data);
                if (vueOptions) {
                    Options.vue = Models.Defaults.mergeObjects(Options.vue, vueOptions);
                    if (vueOptions.layout) {
                        Options.layout = Models.Defaults.mergeObjects(Options.layout, vueOptions.layout);
                    }
                }
                Options.component = componentPath;

                Utils.setupComponent(path.join(Options.rootPath, componentPath), Options, _this.Cache).then(function (component) {

                    var rendered = Renderer.renderHtmlUtil(component);
                    if (!rendered) {
                        reject(new Error('Renderer Error'));
                    } else {
                        var VueClass = rendered.app;
                        var template = Options.layout;
                        var script = rendered.scriptString;
                        var head = new Utils.HeadUtils(Options.vue, rendered.layout.style);

                        var app = new Models.AppClass(VueClass, template, script, head.toString());
                        resolve(app);
                    }
                }).catch(function (error) {
                    reject(error);
                });
            });
        }
        /**
         * renderToStream is the main function used by res.renderVue
         * @param {string} componentPath - full path to .vue component
         * @param  {Object} data          - data to be inserted when generating vue class
         * @param  {Object} vueOptions    - vue options to be used when generating head
         * @return {Promise}              - Promise returns a Stream
         */

    }, {
        key: 'renderToStream',
        value: function renderToStream(componentPath, data, vueOptions) {
            var _this2 = this;

            return new Promise(function (resolve, reject) {
                _this2.createAppObject(componentPath, data, vueOptions).then(function (app) {
                    var vueStream = vueServerRenderer.renderToStream(app.VueClass);
                    var htmlStream = void 0;
                    var htmlStringStart = '' + app.template.html.start + app.head + app.template.body.start + app.template.template.start;
                    var htmlStringEnd = '' + app.template.template.end + app.script + app.template.body.end + app.template.html.end;

                    htmlStream = new Utils.StreamUtils(htmlStringStart, htmlStringEnd);
                    htmlStream = vueStream.pipe(htmlStream);

                    resolve(htmlStream);
                }).catch(function (error) {
                    reject(error);
                });
            });
        }
    }]);

    return ExpressVueRenderer;
}();

module.exports = ExpressVueRenderer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJNb2RlbHMiLCJyZXF1aXJlIiwiTFJVIiwicGF0aCIsIlV0aWxzIiwiUmVuZGVyZXIiLCJ2dWVTZXJ2ZXJSZW5kZXJlciIsImNyZWF0ZVJlbmRlcmVyIiwiY2FjaGVPcHRpb25zIiwibWF4IiwibWF4QWdlIiwibHJ1Q2FjaGUiLCJFeHByZXNzVnVlUmVuZGVyZXIiLCJvcHRpb25zIiwiR2xvYmFsT3B0aW9ucyIsIkRlZmF1bHRzIiwiQ2FjaGUiLCJjb21wb25lbnRQYXRoIiwiZGF0YSIsInZ1ZU9wdGlvbnMiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsIk9wdGlvbnMiLCJPYmplY3QiLCJjcmVhdGUiLCJtZXJnZU9iamVjdHMiLCJ2dWUiLCJsYXlvdXQiLCJjb21wb25lbnQiLCJzZXR1cENvbXBvbmVudCIsImpvaW4iLCJyb290UGF0aCIsInRoZW4iLCJyZW5kZXJlZCIsInJlbmRlckh0bWxVdGlsIiwiRXJyb3IiLCJWdWVDbGFzcyIsImFwcCIsInRlbXBsYXRlIiwic2NyaXB0Iiwic2NyaXB0U3RyaW5nIiwiaGVhZCIsIkhlYWRVdGlscyIsInN0eWxlIiwiQXBwQ2xhc3MiLCJ0b1N0cmluZyIsImNhdGNoIiwiZXJyb3IiLCJjcmVhdGVBcHBPYmplY3QiLCJ2dWVTdHJlYW0iLCJyZW5kZXJUb1N0cmVhbSIsImh0bWxTdHJlYW0iLCJodG1sU3RyaW5nU3RhcnQiLCJodG1sIiwic3RhcnQiLCJib2R5IiwiaHRtbFN0cmluZ0VuZCIsImVuZCIsIlN0cmVhbVV0aWxzIiwicGlwZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUNBOzs7Ozs7QUFDQSxJQUFNQSxTQUFTQyxRQUFRLFVBQVIsQ0FBZjtBQUNBLElBQU1DLE1BQU1ELFFBQVEsV0FBUixDQUFaO0FBQ0EsSUFBTUUsT0FBT0YsUUFBUSxNQUFSLENBQWI7QUFDQSxJQUFNRyxRQUFRSCxRQUFRLFNBQVIsQ0FBZDtBQUNBLElBQU1J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QUllLG1CQUFKO0FBQ0Esd0JBQU1DLHVCQUFxQmYsSUFBSUMsUUFBSixDQUFhZSxJQUFiLENBQWtCQyxLQUF2QyxHQUErQ2pCLElBQUlJLElBQW5ELEdBQTBESixJQUFJQyxRQUFKLENBQWFpQixJQUFiLENBQWtCRCxLQUE1RSxHQUFvRmpCLElBQUlDLFFBQUosQ0FBYUEsUUFBYixDQUFzQmdCLEtBQWhIO0FBQ0Esd0JBQU1FLHFCQUFtQm5CLElBQUlDLFFBQUosQ0FBYUEsUUFBYixDQUFzQm1CLEdBQXpDLEdBQStDcEIsSUFBSUUsTUFBbkQsR0FBNERGLElBQUlDLFFBQUosQ0FBYWlCLElBQWIsQ0FBa0JFLEdBQTlFLEdBQW9GcEIsSUFBSUMsUUFBSixDQUFhZSxJQUFiLENBQWtCSSxHQUE1Rzs7QUFFQU4saUNBQWEsSUFBSWhELE1BQU11RCxXQUFWLENBQXNCTixlQUF0QixFQUF1Q0ksYUFBdkMsQ0FBYjtBQUNBTCxpQ0FBYUYsVUFBVVUsSUFBVixDQUFlUixVQUFmLENBQWI7O0FBRUEvQiw0QkFBUStCLFVBQVI7QUFDSCxpQkFYTCxFQVdPTCxLQVhQLENBV2EsaUJBQVM7QUFDZHpCLDJCQUFPMEIsS0FBUDtBQUNILGlCQWJMO0FBY0gsYUFmTSxDQUFQO0FBZ0JIOzs7Ozs7QUFHTGEsT0FBT0MsT0FBUCxHQUFpQmxELGtCQUFqQiIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG4ndXNlIHN0cmljdCc7XG5jb25zdCBNb2RlbHMgPSByZXF1aXJlKCcuL21vZGVscycpO1xuY29uc3QgTFJVID0gcmVxdWlyZSgnbHJ1LWNhY2hlJyk7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgVXRpbHMgPSByZXF1aXJlKCcuL3V0aWxzJyk7XG5jb25zdCBSZW5kZXJlciA9IHJlcXVpcmUoJy4vcmVuZGVyZXInKTtcbmNvbnN0IHZ1ZVNlcnZlclJlbmRlcmVyID0gcmVxdWlyZSgndnVlLXNlcnZlci1yZW5kZXJlcicpLmNyZWF0ZVJlbmRlcmVyKCk7XG5cbmNvbnN0IGNhY2hlT3B0aW9ucyA9IHtcbiAgICBtYXg6IDUwMCxcbiAgICBtYXhBZ2U6IDEwMDAgKiA2MCAqIDYwXG59O1xuY29uc3QgbHJ1Q2FjaGUgPSBMUlUoY2FjaGVPcHRpb25zKTtcblxuXG4vKipcbiAqIEV4cHJlc3NWdWVSZW5kZXJlciBDbGFzcyBpcyB0aGUgbWFpbiBpbml0IENsYXNzXG4gKiBpbml0IHdpdGggYG5ldyBFeHByZXNzVnVlUmVuZGVyZXIob3B0aW9ucylgXG4gKiByZXR1cm5zIHRoZSBFeHByZXNzVnVlUmVuZGVyZXIgY2xhc3NcbiAqIEBjbGFzc1xuICovXG5jbGFzcyBFeHByZXNzVnVlUmVuZGVyZXIge1xuICAgIEdsb2JhbE9wdGlvbnM6IE1vZGVscy5EZWZhdWx0cztcbiAgICBDYWNoZTogTFJVO1xuICAgIC8qKlxuICAgICAqIEV4cHJlc3NWdWVSZW5kZXJlciBjb25zdHJ1Y3RvclxuICAgICAqIEBjb25zdHJ1Y3RvclxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gVGhlIG9wdGlvbnMgcGFzc2VkIHRvIGluaXQgdGhlIGNsYXNzXG4gICAgICovXG4gICAgY29uc3RydWN0b3Iob3B0aW9uczogT2JqZWN0KSB7XG4gICAgICAgIHRoaXMuR2xvYmFsT3B0aW9ucyA9IG5ldyBNb2RlbHMuRGVmYXVsdHMob3B0aW9ucyk7XG4gICAgICAgIHRoaXMuQ2FjaGUgPSBscnVDYWNoZTtcbiAgICB9XG4gICAgLyoqXG4gICAgICogY3JlYXRlQXBwT2JqZWN0IGlzIGFuIGludGVybmFsIGZ1bmN0aW9uIHVzZWQgYnkgcmVuZGVyVG9TdHJlYW1cbiAgICAgKiBAcGFyYW0gIHtzdHJpbmd9IGNvbXBvbmVudFBhdGggLSBmdWxsIHBhdGggdG8gLnZ1ZSBmaWxlXG4gICAgICogQHBhcmFtICB7T2JqZWN0fSBkYXRhICAgICAgICAgIC0gZGF0YSB0byBiZSBpbnNlcnRlZCB3aGVuIGdlbmVyYXRpbmcgdnVlIGNsYXNzXG4gICAgICogQHBhcmFtICB7T2JqZWN0fSB2dWVPcHRpb25zICAgIC0gdnVlIG9wdGlvbnMgdG8gYmUgdXNlZCB3aGVuIGdlbmVyYXRpbmcgaGVhZFxuICAgICAqIEByZXR1cm4ge1Byb21pc2V9ICAgICAgICAgICAgICAtIFByb21pc2UgY29uc2lzdHMgb2YgYW4gQXBwQ2xhc3MgT2JqZWN0XG4gICAgICovXG4gICAgY3JlYXRlQXBwT2JqZWN0KGNvbXBvbmVudFBhdGg6IHN0cmluZywgZGF0YTogT2JqZWN0LCB2dWVPcHRpb25zOiA/IE9iamVjdCk6IFByb21pc2UgPCBNb2RlbHMuQXBwQ2xhc3MgPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBsZXQgT3B0aW9ucyA9IE9iamVjdC5jcmVhdGUodGhpcy5HbG9iYWxPcHRpb25zKTtcbiAgICAgICAgICAgIE9wdGlvbnMuZGF0YSA9IE1vZGVscy5EZWZhdWx0cy5tZXJnZU9iamVjdHMoT3B0aW9ucy5kYXRhLCBkYXRhKTtcbiAgICAgICAgICAgIC8vIE9wdGlvbnMubWVyZ2VEYXRhT2JqZWN0KGRhdGEpO1xuICAgICAgICAgICAgaWYgKHZ1ZU9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBPcHRpb25zLnZ1ZSA9IE1vZGVscy5EZWZhdWx0cy5tZXJnZU9iamVjdHMoT3B0aW9ucy52dWUsIHZ1ZU9wdGlvbnMpO1xuICAgICAgICAgICAgICAgIGlmICh2dWVPcHRpb25zLmxheW91dCkge1xuICAgICAgICAgICAgICAgICAgICBPcHRpb25zLmxheW91dCA9IE1vZGVscy5EZWZhdWx0cy5tZXJnZU9iamVjdHMoT3B0aW9ucy5sYXlvdXQsIHZ1ZU9wdGlvbnMubGF5b3V0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBPcHRpb25zLmNvbXBvbmVudCA9IGNvbXBvbmVudFBhdGg7XG5cbiAgICAgICAgICAgIFV0aWxzLnNldHVwQ29tcG9uZW50KHBhdGguam9pbihPcHRpb25zLnJvb3RQYXRoLCBjb21wb25lbnRQYXRoKSwgT3B0aW9ucywgdGhpcy5DYWNoZSlcbiAgICAgICAgICAgICAgICAudGhlbigoY29tcG9uZW50KSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVuZGVyZWQgPSBSZW5kZXJlci5yZW5kZXJIdG1sVXRpbChjb21wb25lbnQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXJlbmRlcmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKCdSZW5kZXJlciBFcnJvcicpKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IFZ1ZUNsYXNzID0gcmVuZGVyZWQuYXBwO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBPcHRpb25zLmxheW91dDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNjcmlwdCA9IHJlbmRlcmVkLnNjcmlwdFN0cmluZztcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGhlYWQgPSBuZXcgVXRpbHMuSGVhZFV0aWxzKE9wdGlvbnMudnVlLCByZW5kZXJlZC5sYXlvdXQuc3R5bGUpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhcHAgPSBuZXcgTW9kZWxzLkFwcENsYXNzKFZ1ZUNsYXNzLCB0ZW1wbGF0ZSwgc2NyaXB0LCBoZWFkLnRvU3RyaW5nKCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShhcHApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfSk7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIHJlbmRlclRvU3RyZWFtIGlzIHRoZSBtYWluIGZ1bmN0aW9uIHVzZWQgYnkgcmVzLnJlbmRlclZ1ZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjb21wb25lbnRQYXRoIC0gZnVsbCBwYXRoIHRvIC52dWUgY29tcG9uZW50XG4gICAgICogQHBhcmFtICB7T2JqZWN0fSBkYXRhICAgICAgICAgIC0gZGF0YSB0byBiZSBpbnNlcnRlZCB3aGVuIGdlbmVyYXRpbmcgdnVlIGNsYXNzXG4gICAgICogQHBhcmFtICB7T2JqZWN0fSB2dWVPcHRpb25zICAgIC0gdnVlIG9wdGlvbnMgdG8gYmUgdXNlZCB3aGVuIGdlbmVyYXRpbmcgaGVhZFxuICAgICAqIEByZXR1cm4ge1Byb21pc2V9ICAgICAgICAgICAgICAtIFByb21pc2UgcmV0dXJucyBhIFN0cmVhbVxuICAgICAqL1xuICAgIHJlbmRlclRvU3RyZWFtKGNvbXBvbmVudFBhdGg6IHN0cmluZywgZGF0YTogT2JqZWN0LCB2dWVPcHRpb25zOiBPYmplY3QpOiBQcm9taXNlIDwgT2JqZWN0ID4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5jcmVhdGVBcHBPYmplY3QoY29tcG9uZW50UGF0aCwgZGF0YSwgdnVlT3B0aW9ucylcbiAgICAgICAgICAgICAgICAudGhlbihhcHAgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB2dWVTdHJlYW0gPSB2dWVTZXJ2ZXJSZW5kZXJlci5yZW5kZXJUb1N0cmVhbShhcHAuVnVlQ2xhc3MpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgaHRtbFN0cmVhbTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaHRtbFN0cmluZ1N0YXJ0ID0gYCR7YXBwLnRlbXBsYXRlLmh0bWwuc3RhcnR9JHthcHAuaGVhZH0ke2FwcC50ZW1wbGF0ZS5ib2R5LnN0YXJ0fSR7YXBwLnRlbXBsYXRlLnRlbXBsYXRlLnN0YXJ0fWA7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGh0bWxTdHJpbmdFbmQgPSBgJHthcHAudGVtcGxhdGUudGVtcGxhdGUuZW5kfSR7YXBwLnNjcmlwdH0ke2FwcC50ZW1wbGF0ZS5ib2R5LmVuZH0ke2FwcC50ZW1wbGF0ZS5odG1sLmVuZH1gO1xuXG4gICAgICAgICAgICAgICAgICAgIGh0bWxTdHJlYW0gPSBuZXcgVXRpbHMuU3RyZWFtVXRpbHMoaHRtbFN0cmluZ1N0YXJ0LCBodG1sU3RyaW5nRW5kKTtcbiAgICAgICAgICAgICAgICAgICAgaHRtbFN0cmVhbSA9IHZ1ZVN0cmVhbS5waXBlKGh0bWxTdHJlYW0pO1xuXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoaHRtbFN0cmVhbSk7XG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gRXhwcmVzc1Z1ZVJlbmRlcmVyO1xuIl19